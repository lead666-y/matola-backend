<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Perfil Matola</title>
  <style>
    body {
      background: #111;
      color: #f5c518;
      font-family: sans-serif;
      text-align: center;
      padding: 30px;
    }
    .card {
      background: #222;
      padding: 20px;
      border-radius: 15px;
      max-width: 350px;
      margin: auto;
    }
    input {
      width: 90%;
      padding: 10px;
      border-radius: 5px;
      border: none;
      margin: 10px 0;
    }
    button {
      padding: 10px 15px;
      margin: 10px 5px;
      background: #f5c518;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #000;
    }
    #resumo_id, #loginStatus {
      font-size: 14px;
      color: #ccc;
      margin-top: 10px;
    }
    #avatarPreview {
      width: 100px;
      height: 100px;
      border-radius: 100px;
      object-fit: cover;
      margin-bottom: 10px;
      border: 2px solid #f5c518;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Crie seu Perfil</h2>

    <img id="avatarPreview" src="img/avatar_padrao.png">
    <p style="font-size: 13px; color: #ccc;">Clique no bot√£o de galeria acima para escolher uma foto</p>

    <input type="text" id="nomeUsuario" placeholder="Digite seu nome completo">

    <br>
    <button onclick="criarConta()">Criar Perfil</button>
    <button onclick="continuarSemConta()">Continuar sem perfil</button>
    <button onclick="abrirLogin()">Fazer login</button>
    <p id="resumo_id"></p>

    <div id="loginGrid" style="display:none; margin-top:20px;">
      <h3>Login com ID e Nome</h3>
      <input type="text" id="loginId" placeholder="Seu ID ex: MAT-123456"><br>
      <input type="text" id="loginNome" placeholder="Seu Nome completo"><br>
      <button onclick="fazerLogin()">Entrar</button>
      <p id="loginStatus"></p>
    </div>
  </div>

  <script>
    const API_URL = "https://matola-backend.onrender.com";

    function gerarIDMatola() {
      return "MAT-" + Math.floor(100000 + Math.random() * 899999);
    }

    function criarConta() {
      const nome = document.getElementById("nomeUsuario").value.trim();
      const foto = localStorage.getItem("foto_matola");

      if (nome.length < 3) {
        alert("Digite seu nome completo.");
        return;
      }

      if (!foto) {
        alert("Voc√™ precisa escolher uma imagem de perfil antes.");
        return;
      }

      const id = gerarIDMatola();
      localStorage.setItem("nome_matola", nome);
      localStorage.setItem("id_matola", id);
      localStorage.removeItem("anonimo_matola");

      document.getElementById("resumo_id").textContent =
        `‚úÖ Perfil criado: ${id} ${nome}. Agora voc√™ pode fazer login no app!`;

      fetch(`${API_URL}/salvar_perfil`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, id, foto })
      });

      setTimeout(() => {
        window.location.href = "index.html";
      }, 1000);
    }

    function continuarSemConta() {
      const id = gerarIDMatola();
      localStorage.setItem("anonimo_matola", "true");
      localStorage.setItem("id_matola", id);
      document.getElementById("resumo_id").textContent = `üï∂Ô∏è ID an√¥nimo criado: ${id}`;
      setTimeout(() => {
        window.location.href = "index.html";
      }, 1000);
    }

    const imgPerfil = localStorage.getItem("foto_matola");
    if (imgPerfil) {
      document.getElementById("avatarPreview").src = imgPerfil;
    }

    function abrirLogin() {
      document.getElementById("loginGrid").style.display = "block";
    }

    function fazerLogin() {
      const id = document.getElementById("loginId").value.trim();
      const nome = document.getElementById("loginNome").value.trim();

      if (id.length < 5 || nome.length < 3) {
        document.getElementById("loginStatus").textContent = "‚ö†Ô∏è Preencha ID e Nome corretamente.";
        return;
      }

      fetch(`${API_URL}/login_perfil?id=${encodeURIComponent(id)}&nome=${encodeURIComponent(nome)}`)
        .then(res => {
          if (!res.ok) throw new Error("Erro de conex√£o com o servidor");
          return res.json();
        })
        .then(data => {
          if (data.status === "ok") {
            localStorage.setItem("nome_matola", data.nome);
            localStorage.setItem("id_matola", data.id);
            localStorage.setItem("foto_matola", data.foto);
            document.getElementById("loginStatus").textContent = "‚úÖ Login confirmado!";
            setTimeout(() => {
              window.location.href = "file:///storage/emulated/0/ArmazenarVideos/index.html";
            }, 1000);
          } else {
            document.getElementById("loginStatus").textContent = "‚ùå ID ou Nome inv√°lido!";
          }
        })
        .catch(err => {
          console.error(err);
          document.getElementById("loginStatus").textContent = "‚ö†Ô∏è Erro real ao conectar com o servidor.";
        });
    }
  </script>
</body>
</html>
